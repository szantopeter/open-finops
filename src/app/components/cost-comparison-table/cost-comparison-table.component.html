<div class="cost-comparison-container" *ngIf="costComparisonsArray.length > 0">
  <h3>Cost Comparison Analysis</h3>
  <p class="subtitle">Comparing different AWS RDS Reserved Instance payment scenarios for {{ riPortfolio.metadata.projectionStartDate.getUTCFullYear() }} - {{ riPortfolio.metadata.projectionEndDate.getUTCFullYear() }} <app-question-tooltip [text]="helpHtml.innerHTML"></app-question-tooltip></p>
  <div #helpHtml style="display:none">
    <p>This table shows the annualised cost and savings for different Reserved Instance payment options over the projection period.</p>

    <b><h4>How the numbers are produced:</h4></b>
    <ul>
      <li>Each reservation is paired with the correct price for its instance type, location and payment option.</li>
      <li>Costs are prorated by the days a reservation was active in each month and multiplied by the number of identical reservations when applicable.</li>
      <li>Monthly costs are summed across the entire projection period and converted to a consistent annual figure so different options can be compared fairly.</li>
      <li>Savings are shown against two references: running without any reservations, and your current reservation mix.</li>
    </ul>

    <h4>Adjusted amortised:</h4>
    <ul>
      <li>Some payment options include upfront fees. To compare them fairly we spread (amortise) those upfront fees over the time the reservation is active so they contribute to an annual cost.</li>
      <li>The "adjusted amortised" amount further accounts for changes in coverage during the projection (for example reservations that start or end mid-period or partial-coverage situations) so the reported annual figure reflects the effective cost you actually experience.</li>
      <li>Showing adjusted amortised costs ensures an apples-to-apples comparison between no-upfront, partial-upfront and all-upfront options.</li>
    </ul>
  </div>

  <div class="table-container">
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
      <h4 style="margin: 0;">Annualised reference scenarios</h4>
      <label style="display: flex; align-items: center; gap: 4px; font-size: 14px; cursor: pointer;">
        <input type="checkbox" [(ngModel)]="showOnDemand" style="cursor: pointer;">
        Show on-demand prices
      </label>
    </div>
    <table class="cost-comparison-table">
      <thead>
        <tr>
          <th>Scenario</th>
          <th>Total Upfront</th>
          <th>Total Monthly Payment</th>
          <th>Highest monthly spend</th>
          <th>Total Adjusted Amortised</th>
          <th *ngIf="showOnDemand">Annual savings vs On Demand</th>
          <th>Annual savings vs Current</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of filteredReferenceComparisons" [class.baseline-row]="expandedRow === c.scenario">
          <td class="scenario-cell">{{ getScenarioName(c.scenario) }}</td>
          <td class="currency-cell" [class.zero-value]="isZeroValue(c.totalUpfront)">{{ formatCurrency(c.totalUpfront) }}</td>
          <td class="currency-cell" [class.zero-value]="isZeroValue(c.totalMonthlyPayment)">{{ formatCurrency(c.totalMonthlyPayment) }}</td>
          <td class="currency-cell" [class.zero-value]="isZeroValue(c.highestMonthlySpend)">{{ formatHighestMonthlySpend(c) }}</td>
          <td class="currency-cell" [class.zero-value]="isZeroValue(c.totalCost)">{{ formatCurrency(c.totalCost) }}</td>
          <td *ngIf="showOnDemand" class="savings-cell" [class.savings]="c.savingsPercentOnDemand && c.savingsPercentOnDemand > 0">
            <span *ngIf="c.savingsValueOnDemand !== undefined">{{ formatCurrency(c.savingsValueOnDemand) }} ({{ formatPercent(c.savingsPercentOnDemand) }})</span>
            <span *ngIf="c.savingsValueOnDemand === undefined">-</span>
          </td>
          <td class="savings-current-cell" [class.savings]="c.savingsPercentCurrent && c.savingsPercentCurrent > 0">
            <span *ngIf="c.savingsValueCurrent !== undefined">{{ formatCurrency(c.savingsValueCurrent) }} ({{ formatPercent(c.savingsPercentCurrent) }})</span>
            <span *ngIf="c.savingsValueCurrent === undefined">-</span>
          </td>
          <td class="action-cell">
            <button class="details-button" (click)="toggleMonthlyBreakdown(c.scenario)" [class.expanded]="expandedRow === c.scenario">{{ expandedRow === c.scenario ? 'Hide' : 'Show' }} Details</button>
          </td>
        </tr>
      </tbody>
    </table>

    <h4>Annualised savings Scenarios</h4>
    <table class="cost-comparison-table">
      <thead>
        <tr>
          <th>Scenario</th>
          <th>Total Upfront</th>
          <th>Total Monthly Payment</th>
          <th>Highest monthly spend</th>
          <th>Total Adjusted Amortised</th>
          <th *ngIf="showOnDemand">Annual savings vs On Demand</th>
          <th>Annual savings vs Current</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of savingsComparisons" [class.baseline-row]="expandedRow === c.scenario">
          <td class="scenario-cell">{{ getScenarioName(c.scenario) }}</td>
          <td class="currency-cell" [class.zero-value]="isZeroValue(c.totalUpfront)">{{ formatCurrency(c.totalUpfront) }}</td>
          <td class="currency-cell" [class.zero-value]="isZeroValue(c.totalMonthlyPayment)">{{ formatCurrency(c.totalMonthlyPayment) }}</td>
          <td class="currency-cell" [class.zero-value]="isZeroValue(c.highestMonthlySpend)">{{ formatHighestMonthlySpend(c) }}</td>
          <td class="currency-cell" [class.zero-value]="isZeroValue(c.totalCost)">{{ formatCurrency(c.totalCost) }}</td>
          <td *ngIf="showOnDemand" class="savings-cell" [class.savings]="c.savingsPercentOnDemand && c.savingsPercentOnDemand > 0">
            <span *ngIf="c.savingsValueOnDemand !== undefined">{{ formatCurrency(c.savingsValueOnDemand) }} ({{ formatPercent(c.savingsPercentOnDemand) }})</span>
            <span *ngIf="c.savingsValueOnDemand === undefined">-</span>
          </td>
          <td class="savings-current-cell" [class.savings]="c.savingsPercentCurrent && c.savingsPercentCurrent > 0">
            <span *ngIf="c.savingsValueCurrent !== undefined">{{ formatCurrency(c.savingsValueCurrent) }} ({{ formatPercent(c.savingsPercentCurrent) }})</span>
            <span *ngIf="c.savingsValueCurrent === undefined">-</span>
          </td>
          <td class="action-cell">
            <button class="details-button" (click)="toggleMonthlyBreakdown(c.scenario)" [class.expanded]="expandedRow === c.scenario">{{ expandedRow === c.scenario ? 'Hide' : 'Show' }} Details</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Monthly Breakdown Table -->
  <app-monthly-breakdown-table
    [expandedRow]="expandedRow"
    [timeseries]="currentComparison?.monthlyBreakdown || []"
    [highestSpendMonth]="currentComparison?.highestMonthlySpendMonth" #monthlyBreakdown>
  </app-monthly-breakdown-table>
</div>

<div class="no-data" *ngIf="costComparisonsArray.length === 0">
  <p>No cost comparison data available. Please import RI portfolio data first.</p>
</div>

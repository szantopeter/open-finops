# Quickstart: Monthly RI Cost Visualization

**Feature**: 001-monthly-ri-cost-chart  
**Phase**: 1 (Design)  
**Date**: 2025-11-10

## Prerequisites

Before running this feature, ensure the following are in place:

1. **RI Data Import**: A Cloudability CSV export has been imported via the existing RI upload feature
2. **Pricing Files**: Static pricing files are present in `assets/pricing/` directory
   - Files should be generated by the pricing-generator tool
   - Required fields: instance class, region, multiAZ, engine, edition, upfront payment, duration, upfront amount, monthly recurring amount
3. **Node.js & npm**: Node.js 18+ and npm 9+ installed
4. **Angular CLI**: Angular CLI 20+ installed globally (`npm install -g @angular/cli`)
5. **Dependencies**: All npm packages installed (`npm install`)

---

## Setup

### 1. Install Feature Dependencies

This feature requires ECharts for chart rendering. Install the necessary packages:

```bash
npm install echarts ngx-echarts --save
```

### 2. Verify Pricing Data

Ensure pricing files exist in `assets/pricing/`:

```bash
ls -la src/assets/pricing/
# Expected output: One or more .csv or .json files with pricing data
```

If pricing files are missing, run the pricing-generator tool (manual step, not automated):

```bash
# Follow pricing-generator tool instructions to download AWS RDS pricing data
# Output files should be placed in src/assets/pricing/
```

### 3. Import a Cloudability CSV

The feature requires RI data to be imported. Use the existing import feature:

1. Navigate to the RI import page in the application
2. Upload a Cloudability CSV export file
3. Verify the import completes successfully
4. Check that RI data is stored in IndexedDB (key: `ri-import:v1`)

---

## Running the Feature

### Development Server

Start the Angular development server:

```bash
npm start
# or
ng serve
```

Navigate to `http://localhost:4200` and access the monthly cost chart feature.

### Running Unit Tests

Run all unit tests for the feature services and component:

```bash
npm test
# or
ng test
```

To run tests in CI mode (headless Chrome, single run):

```bash
npm run test:ci
# or
ng test --watch=false --no-progress --code-coverage --browsers ChromeHeadlessCI
```

### Linting

Ensure code passes linting before committing:

```bash
npm run lint
# or
ng lint
```

---

## Using the Feature

### Viewing the Chart

1. **Import RI Data** (if not already done):
   - Navigate to the RI import page
   - Upload a Cloudability CSV file
   - Wait for import to complete

2. **Navigate to Chart**:
   - Go to the monthly cost chart page (route TBD during implementation)
   - Chart should automatically render with default time range (last 12 months or all available months)

3. **Interpret the Chart**:
   - Each **bar** represents one month
   - Each **stacked segment** within a bar represents one RI group (RIs with identical 7-field criteria)
   - Bar **height** shows total cost for that month (sum of all RI groups)
   - **Hover** over a segment to see RI group details and cost breakdown

### Understanding RI Groups

RIs are grouped by **exact match** on all seven categorization fields:
- Instance class (e.g., `db.m5.large`)
- Region (e.g., `us-east-1`)
- Multi-AZ (true/false)
- Engine (e.g., `postgresql`)
- Edition (e.g., `standard`)
- Upfront payment type (e.g., `all-upfront`)
- Duration (e.g., `36` months)

Two RIs are in the same group **only if all seven fields match exactly**.

### Cost Calculation Rules

- **Upfront payments** appear in the **first month** the RI is active
- **Monthly recurring payments** appear in **every month** the RI is active
- **Mid-month starts**: Costs are prorated based on days active (e.g., RI starts Jan 15 → 17/31 of monthly cost in Jan)
- **Mid-month ends**: Costs are prorated based on days active (e.g., RI ends Feb 10 → 10/28 of monthly cost in Feb)

---

## Troubleshooting

### Chart is Empty or Shows "No data available"

**Possible Causes**:
- No RI data has been imported
- All RIs fall outside the selected time range
- RI data in IndexedDB is corrupted or missing

**Solutions**:
1. Verify RI data is imported: Check IndexedDB via browser DevTools → Application → Storage → IndexedDB → `ri-import:v1`
2. Import a Cloudability CSV if no data exists
3. Expand the time range to include RI active periods
4. Clear IndexedDB and re-import RI data

---

### Chart Shows Error: "Pricing data unavailable or invalid"

**Possible Causes**:
- Pricing files are missing from `assets/pricing/`
- Pricing files are malformed (missing required fields)
- Pricing files failed to load at app initialization

**Solutions**:
1. Verify pricing files exist: `ls -la src/assets/pricing/`
2. Regenerate pricing files using the pricing-generator tool
3. Check browser console for detailed error messages
4. Verify file structure matches expected format (7 categorization fields + upfront/monthly amounts)

---

### Chart Shows Error: "X RIs could not be matched to pricing data"

**Possible Causes**:
- Pricing files do not contain pricing data for specific RI configurations
- RI categorization fields in Cloudability CSV do not match pricing file fields (e.g., different region names)
- Pricing files are outdated and missing new RI types

**Solutions**:
1. Check error details for list of unmatched RIs with their categorization fields
2. Verify pricing files contain entries for the unmatched RI configurations
3. Regenerate pricing files with updated AWS RDS pricing data
4. Ensure Cloudability CSV uses consistent field values with pricing files (e.g., region names)

---

### Chart Renders Slowly or Freezes Browser

**Possible Causes**:
- Very large dataset (>500 RIs or >50 groups)
- Browser performance constraints
- Memory leak in chart rendering

**Solutions**:
1. Reduce time range to display fewer months
2. Filter RI data to show only specific regions or instance classes (future enhancement)
3. Check browser console for memory warnings
4. Use Chrome DevTools Performance profiler to identify bottlenecks
5. Verify chart caching is enabled (`ri-monthly-chart:v1` key in IndexedDB)

---

### Unit Tests Fail with "No pricing data available"

**Possible Causes**:
- Test setup does not mock pricing data
- Pricing service not properly initialized in test bed

**Solutions**:
1. Ensure test spec mocks `RiPricingMatcherService.loadPricingData()` to return mock pricing records
2. Provide mock `PricingRecord[]` in test setup
3. Use `jasmine.createSpyObj` to mock pricing service methods
4. Verify test isolation: each test should have independent mock data

---

## Data Flow Summary

```
Cloudability CSV (user upload)
    ↓
RiImportService (parses CSV)
    ↓
IndexedDB (stores RI records via StorageService)
    ↓
RiDataService (provides RI records to chart)
    ↓
RiPricingMatcherService (matches RIs to pricing data from assets/pricing)
    ↓
RiCostAggregationService (calculates monthly costs with proration)
    ↓
MonthlyCostChartComponent (renders stacked bar chart with ECharts)
```

---

## Performance Expectations

Based on success criteria and performance goals:

- **Load Time**: Chart renders within **2 seconds** for datasets up to 500 RIs
- **Calculation Time**: Monthly costs aggregated in **<1 second** for 50 RI groups across 24 months
- **Responsiveness**: Chart interactions (hover, zoom) remain smooth with **<100ms** response time

If performance degrades beyond these thresholds, consider:
- Enabling aggregation caching (`ri-monthly-chart:v1` IndexedDB key)
- Implementing virtual scrolling for large legend lists
- Using Web Workers for cost calculation (future enhancement)

---

## Next Steps

After verifying the feature works correctly:
1. Run full test suite and verify 100% coverage of business logic
2. Run linting and ensure no errors
3. Commit changes to the feature branch (`001-monthly-ri-cost-chart`)
4. Create pull request for code review
5. Update user documentation with chart interpretation guide
6. Add feature to main navigation menu (if not already present)
